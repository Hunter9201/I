<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Login + Email PIN (Admin WhatsApp Flow)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --brand:#0f766e; --brand2:#0ea5e9; --bg:#f6f7fb; }
    body { font-family: system-ui, Arial, sans-serif; background: var(--bg); margin:0; }
    .wrap { max-width: 420px; margin: 40px auto; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:22px; box-shadow:0 6px 18px rgba(0,0,0,.06);}
    h1 { margin:0 0 12px; font-size:22px; }
    label { display:block; margin:10px 0 4px; font-weight:600; }
    input { width:100%; padding:12px; border:1px solid #d1d5db; border-radius:8px; font-size:16px; }
    button { width:100%; padding:12px; margin-top:12px; border:0; border-radius:8px; font-size:16px; background:var(--brand); color:#fff; cursor:pointer; }
    button.secondary { background: var(--brand2); }
    button[disabled]{opacity:.7; cursor:not-allowed;}
    .muted { color:#6b7280; font-size:13px; margin-top:6px; }
    .ok { color:#16a34a; }
    .err { color:#dc2626; }
    .hr { height:1px; background:#e5e7eb; margin:16px 0; }
    .pin-card { border:2px dashed #d1d5db; padding:16px; border-radius:10px; background:#fafafa; }
    .hidden { display:none; }
    .row { display:flex; gap:8px; }
    .row button { width:auto; padding:0 12px; }
    .help { font-size:12px; color:#6b7280; margin-top:4px; }
    .field-row { display:flex; align-items:center; gap:8px; margin-top:8px; }
    .field-row input[type="checkbox"]{ width:auto; }

    /* WhatsApp proof button */
    .whatsapp-proof {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background-color: #25D366;
      color: white;
      font-weight: 600;
      text-decoration: none;
      padding: 10px 16px;
      border-radius: 30px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      transition: all 0.25s ease-in-out;
    }
    .whatsapp-proof:hover { background-color: #1ebe5b; transform: translateY(-2px); box-shadow: 0 5px 14px rgba(0,0,0,0.2); }
    .whatsapp-proof:active { transform: scale(0.96); }
  </style>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>
  <!-- AUTH CARD -->
  <div class="wrap" id="authCard">
    <h1>Sign in</h1>
    <div class="muted">
      Click <b>Create account</b>.<br/>
      We‚Äôll generate a PIN and <b>the admin will WhatsApp it to your number</b> after confirming your payment.
      <br><br>
      <a
        href="https://wa.me/256706315216?text=Hello%20Admin,%20I%20have%20made%20payment%20for%20my%20subscription.%20Here%20is%20my%20proof%20of%20payment."
        target="_blank"
        class="whatsapp-proof"
      >
        üìé Click to send proof of payment
      </a>
    </div>

    <!-- Simple form wrapper helps browser password managers -->
    <form id="authForm" autocomplete="on">
      <label for="email">Email <span class="muted">(required)</span></label>
      <input id="email" name="email" type="email" placeholder="you@example.com"
             autocomplete="username email" required />

      <label for="password">Password</label>
      <div class="row">
        <input id="password" name="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
               autocomplete="current-password" minlength="6" required />
        <button id="togglePwBtn" type="button" style="background:#6b7280;">Show</button>
      </div>
      <div class="help">üîë Don‚Äôt forget your password. Use ‚ÄúRemember me‚Äù so this device keeps it.</div>

      <!-- WhatsApp number field (required for Create account) -->
      <label for="whatsapp">WhatsApp Number <span class="muted">(required for Create account)</span></label>
      <input id="whatsapp" name="tel" type="tel" placeholder="+256701234567"
             autocomplete="tel"
             inputmode="tel"
             pattern="^(\+256|0)\d{9}$" />

      <div class="field-row">
        <input type="checkbox" id="rememberMe" />
        <label for="rememberMe" style="margin:0;font-weight:500;">Remember me on this device</label>
      </div>

      <button id="loginBtn" type="button">Login</button>
      <button id="signupBtn" type="button" class="secondary">Create account</button>
    </form>

    <div class="muted" id="authMsg"></div>
    <div class="hr"></div>
    <div class="muted">After account creation, wait for the admin to WhatsApp your PIN.</div>
  </div>

  <!-- PIN CARD -->
  <div class="wrap hidden" id="pinCard">
    <h1 id="pinTitle">Enter PIN</h1>
    <div id="pinEnterBlock" class="pin-card hidden">
      <div style="margin-bottom:8px;">Enter the <b>6-digit PIN</b> the admin sent you on WhatsApp:</div>
      <label>PIN</label>
      <input id="pinInput" type="password" inputmode="numeric" minlength="6" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <button id="checkPinBtn">Unlock</button>
      <button id="resendPinBtn" class="secondary">Request PIN again</button>
      <div class="muted" id="pinMsg"></div>
    </div>
  </div>

  <script type="module">
    (async () => {
      /* === CONFIG === */
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyAkOZmEaLexWd9b_fOFXTMPvG9KgtHwugQ",
        authDomain: "lionhunter-pins.firebaseapp.com",
        projectId: "lionhunter-pins",
        storageBucket: "lionhunter-pins.firebasestorage.app",
        messagingSenderId: "974538656519",
        appId: "1:974538656519:web:174fd26c77dad4106b53a2",
        measurementId: "G-FP7PJ8XW4E"
      };
      const AFTER_LOGIN_URL = "worksup.html";

      // Admin email (kept in code, as requested)
      const ADMIN_EMAIL = "lionhunter920@gmail.com";

      // EmailJS IDs (unchanged)
      const EMAILJS_SERVICE_ID  = "service_kvuzg36";
      const EMAILJS_TEMPLATE_ID = "template_ngw0gey";
      const EMAILJS_PUBLIC_KEY  = "LrC0wbKy8WjpawS0f";
      const EMAILJS_ENABLED = Boolean(EMAILJS_SERVICE_ID && EMAILJS_TEMPLATE_ID && EMAILJS_PUBLIC_KEY);
      if (EMAILJS_ENABLED && window.emailjs) {
        try { emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY }); } catch {}
      }

      /* === Firebase SDK === */
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js");
      const {
        getAuth, onAuthStateChanged, signInWithEmailAndPassword,
        createUserWithEmailAndPassword, setPersistence, browserLocalPersistence, updateProfile
      } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js");
      const { getFirestore, doc, getDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js");

      const app = initializeApp(FIREBASE_CONFIG);
      const auth = getAuth(app);
      await setPersistence(auth, browserLocalPersistence);
      const db = getFirestore(app);

      /* === Helpers === */
      const $ = (id) => document.getElementById(id);
      const authCard = $("authCard");
      const pinCard = $("pinCard");
      const pinEnterBlock = $("pinEnterBlock");
      const authMsg = $("authMsg");
      const pinMsg = $("pinMsg");
      const pinTitle = $("pinTitle");
      const authForm = $("authForm");
      const show = (el) => el && el.classList.remove("hidden");
      const hide = (el) => el && el.classList.add("hidden");
      const setLoading = (v) => ["loginBtn","signupBtn","checkPinBtn","resendPinBtn"].forEach(id => { const b=$(id); if (b) b.disabled=v; });

      // Resend cooldown
      let lastResendAt = 0;
      const canResend = () => Date.now() - lastResendAt > 60_000;

      // Crypto + PIN
      const hex = (buf) => [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
      const randomHex = (bytes=16) => hex(crypto.getRandomValues(new Uint8Array(bytes)));
      const randomPin6 = () => String(Math.floor(100000 + Math.random()*900000));
      async function sha256Hex(text){ const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text)); return hex(buf); }
      const hashPin = (pin, salt) => sha256Hex(`${pin}:${salt}`);

      // Firestore
      const userRef = (uid) => doc(db, "users", uid);
      const getUserDoc = (uid) => getDoc(userRef(uid));
      async function saveHashedPin(uid, pin){
        const salt = randomHex(16);
        const pinHash = await hashPin(pin, salt);
        await setDoc(userRef(uid), { pinHash, salt, pinSetAt: Date.now() }, { merge:true });
      }

      // Email to ADMIN with WhatsApp number (hardcoded recipient)
      async function sendPinEmailToAdmin({ userEmail, userUid, whatsapp, pin }){
        if (!EMAILJS_ENABLED || !window.emailjs) return false;
        try {
          await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
            to_email: ADMIN_EMAIL,             // always to your email
            requester_email: userEmail,
            requester_uid: userUid,
            whatsapp_number: whatsapp,
            pin: pin,
            project: "Lion Hunter"
          });
          return true;
        } catch (e) { console.error("EmailJS admin send failed:", e); return false; }
      }

      /* === Remember Me (local) === */
      const REMEMBER_KEY = "lionhunter_remember";
      function loadRemembered(){
        try {
          const raw = localStorage.getItem(REMEMBER_KEY);
          if (!raw) return;
          const { email, password, remember } = JSON.parse(raw);
          if (email) $("email").value = email;
          if (password) $("password").value = password;
          $("rememberMe").checked = !!remember;
        } catch {}
      }
      function saveRemembered(){
        const remember = $("rememberMe").checked;
        const payload = {
          remember,
          email: $("email").value.trim() || "",
          // Only store password if box is checked (explicit opt-in)
          password: remember ? ($("password").value || "") : ""
        };
        try { localStorage.setItem(REMEMBER_KEY, JSON.stringify(payload)); } catch {}
      }
      loadRemembered();

      // Credential Management API (best-effort)
      async function storeBrowserCredentials(email, password){
        try {
          if (window.PasswordCredential && navigator.credentials?.store) {
            const cred = new PasswordCredential({ id: email, name: email, password });
            await navigator.credentials.store(cred);
          }
        } catch {}
      }

      /* === UI events === */
      $("togglePwBtn")?.addEventListener("click", () => {
        const p = $("password");
        const showPw = p.type === "password";
        p.type = showPw ? "text" : "password";
        $("togglePwBtn").textContent = showPw ? "Hide" : "Show";
      });

      // Prevent native form submit (we handle clicks)
      authForm?.addEventListener("submit", (e) => e.preventDefault());

      function validateWhatsAppForSignup(){
        const w = $("whatsapp");
        const value = w.value.trim();
        const ok = /^(\+256|0)\d{9}$/.test(value);
        if (!ok) {
          w.setCustomValidity("Enter a valid Uganda number starting with +256 or 0 (e.g., +256701234567).");
        } else {
          w.setCustomValidity("");
        }
        return ok;
      }

      $("loginBtn")?.addEventListener("click", async () => {
        authMsg.textContent = ""; authMsg.className="muted"; setLoading(true);
        try {
          // HTML5 validity first
          if (!authForm.reportValidity()) { throw new Error("Please fill in all required fields."); }

          const email = $("email").value.trim();
          const password = $("password").value;
          if (!email || !password) throw new Error("Enter email and password.");

          // Ensure login uses current-password for password managers
          $("password").setAttribute("autocomplete","current-password");

          const cred = await signInWithEmailAndPassword(auth, email, password);

          // Save remembered (if opted-in)
          saveRemembered();

          // Best-effort store to password manager on login too
          await storeBrowserCredentials(email, password);

        } catch (e) { authMsg.textContent = e.message; authMsg.className="muted err"; console.error(e); }
        finally { setLoading(false); }
      });

      $("signupBtn")?.addEventListener("click", async () => {
        authMsg.textContent = ""; authMsg.className="muted"; setLoading(true);
        try {
          // For sign-up, WhatsApp is compulsory
          if (!validateWhatsAppForSignup()) {
            authForm.reportValidity();
            throw new Error("Enter a valid WhatsApp number.");
          }

          const email = $("email").value.trim();
          const password = $("password").value;
          const whatsapp = $("whatsapp").value.trim();

          if (!email || !password || !whatsapp) throw new Error("Enter email, password, and WhatsApp number.");

          // Nudge password managers to treat this as a new password
          $("password").setAttribute("autocomplete","new-password");

          const cred = await createUserWithEmailAndPassword(auth, email, password);
          try { await updateProfile(cred.user, { displayName: email.split("@")[0] }); } catch {}

          // Save WhatsApp on the user doc (so you can see it later)
          await setDoc(userRef(cred.user.uid), { whatsapp_number: whatsapp }, { merge: true });

          // Generate + save PIN
          const pin = randomPin6();
          await saveHashedPin(cred.user.uid, pin);

          // Email ADMIN with details
          const mailed = await sendPinEmailToAdmin({ userEmail: email, userUid: cred.user.uid, whatsapp, pin });
          authMsg.textContent = mailed
            ? "Account created. Admin will WhatsApp you the PIN shortly."
            : "Account created. Admin notification failed ‚Äî please contact the admin.";
          authMsg.className = mailed ? "muted ok" : "muted err";

          // Save remembered (if opted-in)
          saveRemembered();

          // Store credentials in browser password manager (best-effort)
          await storeBrowserCredentials(email, password);

          hide(authCard); show(pinCard); show(pinEnterBlock); pinTitle.textContent = "Enter PIN";
        } catch (e) { authMsg.textContent = e.message; authMsg.className="muted err"; console.error(e); }
        finally { setLoading(false); }
      });

      $("checkPinBtn")?.addEventListener("click", async () => {
        pinMsg.textContent = ""; pinMsg.className="muted"; setLoading(true);
        try {
          const u = auth.currentUser; if (!u) throw new Error("Not signed in.");
          const pin = $("pinInput").value.trim();
          if (!/^\d{6}$/.test(pin)) throw new Error("Enter your 6-digit PIN.");

          const snap = await getUserDoc(u.uid);
          const data = snap.data() || {};
          if (!data.pinHash || !data.salt) throw new Error("No PIN set yet. Ask admin to send it.");

          const candidate = await sha256Hex(`${pin}:${data.salt}`);
          if (candidate !== data.pinHash) throw new Error("Wrong PIN.");

          sessionStorage.setItem("pin_ok", "1");
          localStorage.setItem("lion_access_pin", JSON.stringify({ usedAt: new Date().toISOString() }));

          window.location.href = AFTER_LOGIN_URL;
        } catch (e) { pinMsg.textContent = e.message; pinMsg.className="muted err"; console.error(e); }
        finally { setLoading(false); }
      });

      $("resendPinBtn")?.addEventListener("click", async () => {
        pinMsg.textContent = ""; pinMsg.className="muted"; setLoading(true);
        try {
          if (!canResend()) { pinMsg.textContent = "Please wait a minute before requesting again."; pinMsg.className="muted err"; return; }
          const u = auth.currentUser; if (!u) throw new Error("Not signed in.");

          const snap = await getUserDoc(u.uid);
          const whatsapp = snap.data()?.whatsapp_number || "Not provided";

          const newPin = randomPin6();
          await saveHashedPin(u.uid, newPin);

          const mailed = await sendPinEmailToAdmin({ userEmail: u.email, userUid: u.uid, whatsapp, pin: newPin });
          pinMsg.textContent = mailed
            ? "Request sent. Admin will WhatsApp you a new PIN."
            : "Could not notify admin ‚Äî please try again later.";
          pinMsg.className = mailed ? "muted ok" : "muted err";
          lastResendAt = Date.now();
        } catch (e) { pinMsg.textContent = e.message; pinMsg.className="muted err"; console.error(e); }
        finally { setLoading(false); }
      });

      onAuthStateChanged(auth, async (user) => {
        if (!user) { show(authCard); hide(pinCard); return; }
        hide(authCard); show(pinCard);
        try {
          const snap = await getUserDoc(user.uid);
          const data = snap.data() || {};
          show(pinEnterBlock); pinTitle.textContent = "Enter PIN";
          if (!data.pinHash || !data.salt) {
            pinMsg.textContent = "No PIN found yet. Ask admin to send it."; pinMsg.className="muted";
          }
        } catch (e) {
          show(pinEnterBlock); pinTitle.textContent = "Enter PIN"; console.error(e);
        }
      });
    })();
  </script>
</body>
</html>
