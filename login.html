<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Login + Email PIN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --brand:#0f766e; --brand2:#0ea5e9; --bg:#f6f7fb; }
    body { font-family: system-ui, Arial, sans-serif; background: var(--bg); margin:0; }
    .wrap { max-width: 420px; margin: 40px auto; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:22px; box-shadow:0 6px 18px rgba(0,0,0,.06);}
    h1 { margin:0 0 12px; font-size:22px; }
    label { display:block; margin:10px 0 4px; font-weight:600; }
    input { width:100%; padding:12px; border:1px solid #d1d5db; border-radius:8px; font-size:16px; }
    button { width:100%; padding:12px; margin-top:12px; border:0; border-radius:8px; font-size:16px; background:var(--brand); color:#fff; cursor:pointer; }
    button.secondary { background: var(--brand2); }
    button.warn { background:#ef4444; }
    button[disabled]{opacity:.7; cursor:not-allowed;}
    .muted { color:#6b7280; font-size:13px; margin-top:6px; }
    .ok { color:#16a34a; }
    .err { color:#dc2626; }
    .hr { height:1px; background:#e5e7eb; margin:16px 0; }
    .pin-card { border:2px dashed #d1d5db; padding:16px; border-radius:10px; background:#fafafa; }
    .hidden { display:none; }
    .row { display:flex; gap:8px; }
    .row button { width:auto; padding:0 12px; }
  </style>

  <!-- EmailJS (client-side email) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>
  <!-- AUTH CARD -->
  <div class="wrap" id="authCard">
    <h1>Sign in</h1>
    <div class="muted">Use email + password. New? Click <b>Create account</b>. We’ll email you a 6-digit PIN.</div>

    <label for="email">Email</label>
    <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />

    <label for="password">Password</label>
    <div class="row">
      <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
      <button id="togglePwBtn" type="button" style="background:#6b7280;">Show</button>
    </div>

    <button id="loginBtn">Login</button>
    <button id="signupBtn" class="secondary">Create account</button>

    <div class="muted" id="authMsg"></div>
    <div class="hr"></div>
    <div class="muted">After account creation, check your email for the PIN.</div>
  </div>

  <!-- PIN CARD -->
  <div class="wrap hidden" id="pinCard">
    <h1 id="pinTitle">Enter PIN</h1>

    <!-- Enter PIN -->
    <div id="pinEnterBlock" class="pin-card hidden">
      <div style="margin-bottom:8px;">We emailed you a 6-digit PIN. Enter it to continue:</div>
      <label>PIN</label>
      <input id="pinInput" type="password" inputmode="numeric" minlength="6" maxlength="6" placeholder="••••••" />
      <button id="checkPinBtn">Unlock</button>
      <button id="resendPinBtn" class="secondary">Resend PIN to my email</button>
      <div class="muted" id="pinMsg"></div>
    </div>
  </div>

 <script type="module">
  /*********** 1) CONFIG — FILL THESE ***********/
  const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAkOZmEaLexWd9b_fOFXTMPvG9KgtHwugQ",
  authDomain: "lionhunter-pins.firebaseapp.com",
  projectId: "lionhunter-pins",
  storageBucket: "lionhunter-pins.firebasestorage.app",
  messagingSenderId: "974538656519",
  appId: "1:974538656519:web:174fd26c77dad4106b53a2",
  measurementId: "G-FP7PJ8XW4E"
  };
  // After correct PIN
  const AFTER_LOGIN_URL = "worksup.html";

  // EmailJS (optional; leave blank to skip)
  const EMAILJS_SERVICE_ID  = "service_kvuzg36";
  const EMAILJS_TEMPLATE_ID = "template_ngw0gey";
  const EMAILJS_PUBLIC_KEY  = "LrC0wbKy8WjpawS0f";
  const EMAILJS_ENABLED = !!(service_kvuzg36&& template_ngw0gey && LrC0wbKy8WjpawS0f);

  if (EMAILJS_ENABLED) {
    // load EmailJS SDK
    const s = document.createElement("script");
    s.src = "https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js";
    s.onload = () => emailjs.init({ publicKey: LrC0wbKy8WjpawS0f });
    document.head.appendChild(s);
  }

  /*********** 2) FIREBASE SDK ***********/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword,
    createUserWithEmailAndPassword, setPersistence, browserLocalPersistence, updateProfile
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, deleteField
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const app = initializeApp(FIREBASE_CONFIG);
  const auth = getAuth(app);
  await setPersistence(auth, browserLocalPersistence);
  const db = getFirestore(app);

  /*********** 3) DOM HELPERS ***********/
  const $ = (id) => document.getElementById(id);
  const authCard = $("authCard");
  const pinCard = $("pinCard");
  const pinSetBlock = $("pinSetBlock");      // may be hidden in this flow
  const pinEnterBlock = $("pinEnterBlock");
  const authMsg = $("authMsg");
  const pinSetMsg = $("pinSetMsg");
  const pinMsg = $("pinMsg");
  const pinTitle = $("pinTitle");
  const show = (el) => el && el.classList.remove("hidden");
  const hide = (el) => el && el.classList.add("hidden");
  const setLoading = (v) => ["loginBtn","signupBtn","savePinBtn","checkPinBtn","resetPinBtn"]
    .forEach(id => { const b=$(id); if (b) b.disabled=v; });

  /*********** 4) CRYPTO HELPERS ***********/
  const hex = (buf) => [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
  function randomHex(bytes=16){ return hex(crypto.getRandomValues(new Uint8Array(bytes))); }
  function randomPin6(){ return String(Math.floor(100000 + Math.random()*900000)); }
  async function sha256Hex(text){
    const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
    return hex(buf);
  }
  async function hashPin(pin, salt){ return sha256Hex(`${pin}:${salt}`); }

  /*********** 5) FIRESTORE HELPERS ***********/
  const userRef = (uid) => doc(db, "users", uid);
  const getUserDoc = (uid) => getDoc(userRef(uid));
  async function saveHashedPin(uid, pin){
    const salt = randomHex(16);
    const pinHash = await hashPin(pin, salt);
    await setDoc(userRef(uid), { pinHash, salt, pinSetAt: Date.now() }, { merge:true });
  }

  /*********** 6) EMAIL SENDER ***********/
  async function sendPinEmail(toEmail, pin){
    if (!EMAILJS_ENABLED || !window.emailjs) return false;
    try {
      await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
        to_email: toEmail,   // must exist in your template “To Email”
        pin: pin,            // used in subject/body
        project: "Lion Hunter"
      });
      return true;
    } catch (e) {
      console.error("EmailJS send failed:", e);
      return false;
    }
  }

  /*********** 7) UI EVENTS ***********/
  $("togglePwBtn")?.addEventListener("click", () => {
    const p = $("password"); const showPw = p.type === "password";
    p.type = showPw ? "text" : "password";
    $("togglePwBtn").textContent = showPw ? "Hide" : "Show";
  });

  $("loginBtn")?.addEventListener("click", async () => {
    authMsg.textContent = ""; authMsg.className="muted"; setLoading(true);
    try {
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) throw new Error("Enter email and password.");
      await signInWithEmailAndPassword(auth, email, password);
      // will switch UI in onAuthStateChanged
    } catch (e) {
      authMsg.textContent = e.message; authMsg.className="muted err";
      console.error(e);
    } finally { setLoading(false); }
  });

  $("signupBtn")?.addEventListener("click", async () => {
    authMsg.textContent = ""; authMsg.className="muted"; setLoading(true);
    try {
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) throw new Error("Enter email and password.");

      const cred = await createUserWithEmailAndPassword(auth, email, password);
      try { await updateProfile(cred.user, { displayName: email.split("@")[0] }); } catch {}

      // Generate & save PIN first
      const pin = randomPin6();
      await saveHashedPin(cred.user.uid, pin);

      // Try to send email; if it fails, still proceed and show info
      const mailed = await sendPinEmail(email, pin);
      if (mailed) {
        authMsg.textContent = "Account created. PIN sent to your email."; authMsg.className="muted ok";
      } else {
        authMsg.textContent = "Account created. Email sending failed — use the PIN shown in the console."; authMsg.className="muted err";
        console.warn("TEST PIN (not emailed):", pin); // visible only to you while testing
      }

      // Move to PIN entry regardless
      hide(authCard); show(pinCard); show(pinEnterBlock); pinTitle.textContent = "Enter PIN";
    } catch (e) {
      authMsg.textContent = e.message; authMsg.className="muted err";
      console.error(e);
    } finally { setLoading(false); }
  });

  $("checkPinBtn")?.addEventListener("click", async () => {
    pinMsg.textContent = ""; pinMsg.className="muted"; setLoading(true);
    try {
      const u = auth.currentUser; if (!u) throw new Error("Not signed in.");
      const pin = $("pinInput").value.trim();
      if (!/^\d{6}$/.test(pin)) throw new Error("Enter the 6-digit PIN sent to your email.");

      const snap = await getUserDoc(u.uid);
      const data = snap.data() || {};
      if (!data.pinHash || !data.salt) throw new Error("No PIN set yet. Try Resend PIN.");

      const candidate = await hashPin(pin, data.salt);
      if (candidate !== data.pinHash) throw new Error("Wrong PIN.");

      sessionStorage.setItem("pin_ok", "1");
      window.location.href = AFTER_LOGIN_URL;
    } catch (e) {
      pinMsg.textContent = e.message; pinMsg.className="muted err";
      console.error(e);
    } finally { setLoading(false); }
  });

  // Optional: add a Resend button if you want (same logic as sendPinEmail)
  // document.getElementById('resendPinBtn')...

  /*********** 8) AUTH STATE → UI ***********/
  onAuthStateChanged(auth, async (user) => {
    if (!user) { show(authCard); hide(pinCard); return; }
    hide(authCard); show(pinCard);
    try {
      const snap = await getUserDoc(user.uid);
      const data = snap.data() || {};
      show(pinEnterBlock); pinTitle.textContent = "Enter PIN";
      if (!data.pinHash || !data.salt) {
        pinMsg.textContent = "No PIN found yet. Click Create account again or ask admin to resend.";
      }
    } catch (e) {
      show(pinEnterBlock); pinTitle.textContent = "Enter PIN";
      console.error(e);
    }
  });
</script>

</body>
</html>
